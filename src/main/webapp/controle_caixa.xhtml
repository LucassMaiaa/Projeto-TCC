<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<!-- Usando o template com sidebar -->
<ui:composition template="/WEB-INF/template-with-sidebar.xhtml">

	<!-- T√≠tulo da p√°gina -->
	<ui:define name="title">Controle de Caixa - BarberSys</ui:define>
	
	<!-- CSS espec√≠fico desta p√°gina -->
	<ui:define name="extra-css">
		<h:outputScript library="primefaces" name="locales/locale-pt.js" />
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		<style>
.content-agendamentos {
	border-radius: 0px;
	height: 100vh;
	max-height: calc(100vh - 354px);
	padding: 15px 20px 30px;
}

.content-info-lateral {
	background: #FCFCFF;
}

.content-valores {
	height: 204px;
}

body .ui-datatable thead tr:not(.ui-datatable-empty-message), body .ui-datatable tbody tr:not(.ui-datatable-empty-message)
	{
	display: grid;
	grid-template-columns: 62px 150px 110px 70px 1fr;
}

body .ui-datatable thead th:first-child:not(.ui-datatable-empty-message),
	body .ui-datatable tbody td:first-child:not(.ui-datatable-empty-message)
	{
	text-align: center !important;
}

body .ui-dialog:has( .header-modal) .ui-dialog-content {
	padding: 20px;
	width: 400px;
	min-width: 400px !important;
	max-height: 80vh !important;
	overflow-y: auto !important;
}

/* Ajuste local de z-index apenas para o overlay deste dialog do Controle de Caixa */
body .ui-widget-overlay.ui-dialog-mask[id$="dlgSaldo_modal"] {
	z-index: 1000 !important;
}

body .ui-dialog[id$="dlgSaldo"] {
	z-index: 1001 !important;
	position: fixed !important;
	top: 50% !important;
	left: 50% !important;
	transform: translate(-50%, -50%) !important;
	margin: 0 !important;
}

/* Scrollbar customizada para o modal */
body .ui-dialog:has( .header-modal) .ui-dialog-content::-webkit-scrollbar {
	width: 6px;
}

body .ui-dialog:has( .header-modal) .ui-dialog-content::-webkit-scrollbar-track {
	background: #F0F4F8;
	border-radius: 3px;
}

body .ui-dialog:has( .header-modal) .ui-dialog-content::-webkit-scrollbar-thumb {
	background: #CCC;
	border-radius: 3px;
}

body .ui-dialog:has( .header-modal) .ui-dialog-content::-webkit-scrollbar-thumb:hover {
	background: #999;
}
		</style>
		
		<script type="text/javascript">
			function debugModal() {
				console.log('=== DEBUG MODAL ===');
				var input = document.querySelector('input[id*="valorInicialInput"]');
				if (input) {
					console.log('Input encontrado:', input);
					console.log('Valor do input:', input.value);
				} else {
					console.log('Input N√ÉO encontrado!');
				}
			}
			
			function handleCaixaResponse(args) {
				console.log('üîî handleCaixaResponse chamado:', args);
				
				if (args &amp;&amp; args.validado === true) {
					// Sucesso
					PF('dlgSaldo').hide();
					Swal.fire({
						icon: 'success',
						title: 'Sucesso!',
						text: args.mensagem || 'Opera√ß√£o realizada com sucesso!',
						showConfirmButton: false,
						timer: 2000
					});
				} else if (args &amp;&amp; args.validado === false) {
					// Erro
					Swal.fire({
						icon: 'error',
						title: args.titulo || 'Erro!',
						text: args.mensagem || 'Ocorreu um erro ao processar a opera√ß√£o.',
						showConfirmButton: false,
						timer: 3000
					});
				}
			}
			
			function handleEntradaSaidaResponse(args) {
				console.log('üí∞ handleEntradaSaidaResponse chamado:', args);
				
				if (args &amp;&amp; args.validado === true) {
					// Sucesso
					Swal.fire({
						icon: 'success',
						title: 'Sucesso!',
						text: args.mensagem || 'Movimenta√ß√£o registrada com sucesso!',
						showConfirmButton: false,
						timer: 2000
					});
				} else if (args &amp;&amp; args.validado === false) {
					// Erro
					Swal.fire({
						icon: 'error',
						title: args.titulo || 'Erro!',
						text: args.mensagem || 'Ocorreu um erro ao processar a opera√ß√£o.',
						showConfirmButton: false,
						timer: 3000
					});
				}
			}
		</script>
	</ui:define>

	<!-- Conte√∫do CENTRAL da p√°gina -->
	<ui:define name="content">
	
		<!-- T√≠tulo da p√°gina -->
		<div class="flex space-between">
			<p:outputLabel class="title-page" value="Extrato do caixa" />
		</div>

		<!-- Filtros -->
		<div class="header-filters">
			<div class="row">
				<div class="col-md-4">
					<div class="content-filter ">
						<i class="fa-solid fa-filter"></i>
						<p:selectOneButton
							value="#{controleCaixaController.filtroTipoDeValor}"
							unselectable="false">
							<f:selectItem itemLabel="Todos" itemValue="" />
							<f:selectItem itemLabel="Entradas" itemValue="Entrada" />
							<f:selectItem itemLabel="Sa√≠das" itemValue="Saida" />
							<p:ajax update="@form" process="@this" />
						</p:selectOneButton>
					</div>
				</div>
			</div>
		</div>

		<!-- Tabela de dados -->
		<div>
			<p:dataTable id="datatableCaixas" rowIndexVar="row"
				class="data-table-info"
				value="#{controleCaixaController.lstControleCaixa}" var="caixa"
				paginator="true" paginatorPosition="bottom" rows="13" lazy="true"
				emptyMessage="Nenhum dado encontrado">

				<p:column headerText="C√≥digo">
					<h:outputText value="#{row + 1}" />
				</p:column>

				<p:column headerText="Movimenta√ß√£o">
					<h:outputText value="#{caixa.movimentacao}" />
				</p:column>

				<p:column headerText="Valores/Lucros">
					<h:outputText value="#{caixa.valor}">
						<f:convertNumber type="currency" currencySymbol="R$"
							locale="pt_BR" />
					</h:outputText>
				</p:column>

				<p:column headerText="Hora">
					<h:outputText value="#{caixa.horaAtual.substring(0,5)}" />
				</p:column>

				<p:column headerText="Motivo">
					<h:outputText value="#{caixa.motivo}" />
				</p:column>

			</p:dataTable>
		</div>
		
					<!-- Modal de Saldo -->
			<p:dialog id="dlgSaldo" widgetVar="dlgSaldo" modal="true"
				showEffect="fade" hideEffect="fade" closable="false"
				draggable="false" resizable="false" fitViewport="true" responsive="true">
			<h:panelGroup id="dlgSaldoForm">
				<div class="header-modal">
					<div class="flex align-center">
						<div class="icon-circle">
							<i class="fa-solid fa-money-bill-transfer"></i>
						</div>
						<label>
							#{controleCaixaController.statusSelecionado eq 'A' ? 'Valor Inicial do Caixa' : 'Valor Final do Caixa'}
						</label>
					</div>
				</div>
				<p:messages id="modalMessages" showDetail="true" closable="true" />

				<!-- Campo para ABERTURA de caixa -->
				<ui:fragment rendered="#{controleCaixaController.statusSelecionado eq 'A'}">
					<div class="row">
						<div class="col-md-12">
							<div class="input-combined">
								<p:outputLabel class="title-input" value="Valor Inicial *" />
								
								<p:inputNumber id="valorInicialInput" 
									symbol="R$ " 
									decimalPlaces="2"
									value="#{controleCaixaController.valorInicialTemp}"
									widgetVar="widgetValorInicial"
									required="false" />
							</div>
						</div>
					</div>
				</ui:fragment>

				<!-- Campos para FECHAMENTO de caixa -->
				<ui:fragment rendered="#{controleCaixaController.statusSelecionado eq 'I'}">
					<!-- Mensagem informativa com c√°lculo autom√°tico -->
					<div style="background: #E8F5E9; border-left: 4px solid #66BB6A; padding: 12px 16px; border-radius: 4px; margin-bottom: 16px;">
						<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
							<i class="fa-solid fa-calculator" style="color: #66BB6A; font-size: 16px;"></i>
							<span style="font-weight: 700; font-size: 13px; color: #2C4A2C;">C√°lculo Autom√°tico do Caixa</span>
						</div>
						<p style="margin: 0; font-size: 13px; color: #5A7A5A; line-height: 1.5;">
							Com base nas movimenta√ß√µes de hoje, o valor esperado para fechamento √©: 
							<strong style="color: #2C4A2C;">#{controleCaixaController.formatarValor(controleCaixaController.valorSugerido)}</strong>
						</p>
					</div>
					
					<div class="row">
						<div class="col-md-12">
							<div class="input-combined">
								<p:outputLabel class="title-input" value="Valor Final *" />
								<p:inputNumber id="valorFinalInput" 
									symbol="R$ " 
									decimalPlaces="2"
									value="#{controleCaixaController.valorFinalTemp}"
									widgetVar="widgetValorFinal"
									required="false">
									<p:ajax event="change" update="@form:areaMotivo" process="@this" />
								</p:inputNumber>
							</div>
						</div>
					</div>
					
					<!-- √Årea do motivo (atualiza dinamicamente) -->
					<h:panelGroup id="areaMotivo">
						<ui:fragment rendered="#{controleCaixaController.valorFinalTemp != null and controleCaixaController.valorFinalTemp lt controleCaixaController.valorSugerido}">
							<div style="background: #FFF3E0; border-left: 4px solid #FF9800; padding: 12px 16px; border-radius: 4px; margin: 16px 0;">
								<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
									<i class="fa-solid fa-triangle-exclamation" style="color: #FF9800; font-size: 16px;"></i>
									<span style="font-weight: 700; font-size: 13px; color: #E65100;">Aten√ß√£o: Valor Menor que o Esperado</span>
								</div>
								<p style="margin: 0; font-size: 12px; color: #8D6E63; line-height: 1.5;">
									O valor informado √© <strong>#{controleCaixaController.formatarValor(controleCaixaController.valorSugerido - controleCaixaController.valorFinalTemp)}</strong> menor que o calculado. 
									Por favor, informe o motivo da diferen√ßa.
								</p>
							</div>
							
							<div class="row">
								<div class="col-md-12">
									<div class="input-combined">
										<p:outputLabel class="title-input" value="Motivo da Diferen√ßa *" style="color: #E65100; font-weight: 700;" />
										<p:inputTextarea maxlength="200"
											value="#{controleCaixaController.mensagemMotivoFinal}"
											placeholder="Informe o motivo do valor divergente..."
											style="border-color: #FF9800;" />
									</div>
								</div>
							</div>
						</ui:fragment>
						
						<ui:fragment rendered="#{controleCaixaController.valorFinalTemp == null or controleCaixaController.valorFinalTemp ge controleCaixaController.valorSugerido}">
							<div class="row">
								<div class="col-md-12">
									<div class="input-combined">
										<p:outputLabel class="title-input" value="Observa√ß√µes (Opcional)" />
										<p:inputTextarea maxlength="200"
											value="#{controleCaixaController.mensagemMotivoFinal}"
											placeholder="Adicione observa√ß√µes sobre o fechamento..." />
									</div>
								</div>
							</div>
						</ui:fragment>
					</h:panelGroup>
				</ui:fragment>

			<div class="flex justify-center mt15">
				<ui:fragment
					rendered="#{controleCaixaController.statusSelecionado eq 'A'}">
					<p:commandButton 
						id="btnRegistrarAbertura"
						styleClass="btn btn-blue medium" 
						value="Registrar"
						update="dlgSaldoForm @form:attCaixa @form:vlrCaixa @form:datatableCaixas @form:attBtnCaixa @form:camposEntradaSaida @form:btnRegistrarEntradaSaida"
						process="@form"
						actionListener="#{controleCaixaController.salvarRegistroInicial()}"
						oncomplete="handleCaixaResponse(args);" />
				</ui:fragment>
				<ui:fragment
					rendered="#{controleCaixaController.statusSelecionado eq 'I'}">
					<p:commandButton 
						id="btnRegistrarFechamento"
						styleClass="btn btn-blue medium" 
						value="Registrar"
						update="dlgSaldoForm @form:attCaixa @form:vlrCaixa @form:datatableCaixas @form:attBtnCaixa @form:camposEntradaSaida @form:btnRegistrarEntradaSaida"
						process="@form"
						actionListener="#{controleCaixaController.salvarRegistroFinal()}"
						oncomplete="handleCaixaResponse(args);" />
				</ui:fragment>
			</div>
			</h:panelGroup>
		</p:dialog>
		

	</ui:define>

	<!-- Conte√∫do da SIDEBAR DIREITA -->
	<ui:define name="sidebar">
				<div class="content-logo-system">
					<div class="flex">
						<div class="icon-circle">
							<i class="fa-solid fa-money-bills"></i>
						</div>
						<div class="subtitle-info">
							<label class="title-info">Controle de Caixa</label>
						</div>
					</div>
				</div>
				<div class="content-btns flex">
					<p:selectOneButton disabled="#{controleCaixaController.chaveCaixa}"
						id="attBtnCaixa"
						value="#{controleCaixaController.statusSelecionado}"
						unselectable="false">
						<f:selectItem itemLabel="Aberto" itemValue="A" />
						<f:selectItem itemLabel="Fechado" itemValue="I" />
						<p:ajax event="change" 
							listener="#{controleCaixaController.prepararModal()}"
							update="dlgSaldo attBtnCaixa"
							process="@this"
							oncomplete="console.log('args.aberto:', args.aberto); if (args.aberto) { console.log('Abrindo modal...'); PF('dlgSaldo').show(); }" />
					</p:selectOneButton>

					<p:outputPanel id="attCaixa">
						<div>
							<p:outputLabel class="title-date"
								value="#{controleCaixaController.dataSelecionada}">
								<f:convertDateTime pattern="dd/MM/yyyy" />
							</p:outputLabel>
							<ui:fragment
								rendered="#{controleCaixaController.statusSelecionado eq 'I'}">
								<p:outputLabel class="title-date" style="background: #C52323"
									value="Fechado" />
							</ui:fragment>
							<ui:fragment
								rendered="#{controleCaixaController.statusSelecionado eq 'A'}">
								<p:outputLabel class="title-date" style="background: #23C538 "
									value="Aberto" />
							</ui:fragment>

						</div>
					</p:outputPanel>

				</div>
				<div class="content-valores">
					<h:panelGroup id="vlrCaixa">
						<div class="input-combined input-valores">
							<div class="row">
								<div class="col-md-6">
									<p:outputLabel class="title-input" value="Caixa inicial" />
									<p:inputNumber symbol="R$ "
										value="#{controleCaixaController.valorInicial}"
										readonly="true" />
								</div>
								<div class="col-md-6">
									<p:outputLabel class="title-input" value="Caixa Final" />
									<p:inputNumber symbol="R$ "
										value="#{controleCaixaController.valorFinal}" readonly="true" />
								</div>
							</div>

							<div class="row">
								<div class="col-md-6">
									<p:outputLabel class="title-input"
										value="Total de entradas no dia" />
									<p:inputNumber symbol="R$ "
										value="#{controleCaixaController.totalEntradas}"
										readonly="true" />
								</div>
								<div class="col-md-6">
									<p:outputLabel class="title-input"
										value="Total de sa√≠das no dia" />
									<p:inputNumber symbol="R$ "
										value="#{controleCaixaController.totalSaidas}" readonly="true" />
								</div>
							</div>

							<div class="row">
								<div class="col-md-6">
									<p:outputLabel class="title-input"
										value="Total de entradas no m√™s" />
									<p:inputNumber symbol="R$ "
										value="#{controleCaixaController.totalEntradasMes}"
										readonly="true" />
								</div>
								<div class="col-md-6">
									<p:outputLabel class="title-input"
										value="Total de sa√≠das no m√™s" />
									<p:inputNumber symbol="R$ "
										value="#{controleCaixaController.totalSaidasMes}"
										readonly="true" />
								</div>
							</div>

						</div>
					</h:panelGroup>

				</div>
			<div class="content-agendamentos flex column space-between">
				<h:panelGroup id="camposEntradaSaida">
				<div>
					<div class="select-segundario no-filter">
						<p:selectOneButton value="#{controleCaixaController.tipodeValor}"
							unselectable="false">
							<f:selectItem itemLabel="Entrada" itemValue="e" />
							<f:selectItem itemLabel="Sa√≠da" itemValue="s" />
							<p:ajax update="@form" process="@this" />
						</p:selectOneButton>
					</div>

					<p:growl />
					<div class="row">
						<div class="col-md-6">
							<ui:fragment
								rendered="#{controleCaixaController.tipodeValor eq 'e'}">
								<div class="input-combined">
									<p:outputLabel class="title-input" value="Valor de entrada *" />
									<p:inputNumber symbol="R$ "
										value="#{controleCaixaController.controleCaixaModel.valor}"
										disabled="#{controleCaixaController.dadosLiberados}" />
								</div>
							</ui:fragment>
							<ui:fragment
								rendered="#{controleCaixaController.tipodeValor eq 's'}">
								<div class="input-combined">
									<p:outputLabel class="title-input" value="Valor de sa√≠da *" />
									<p:inputNumber symbol="R$ "
										value="#{controleCaixaController.controleCaixaModel.valor}"
										disabled="#{controleCaixaController.dadosLiberados}" />
								</div>
							</ui:fragment>
						</div>
						<div class="col-md-6">
							<div class="input-combined">
								<p:outputLabel class="title-input" value="Data do caixa" />
								<p:datePicker showIcon="true"
									value="#{controleCaixaController.dataSelecionada}"
									pattern="dd/MM/yyyy">
									<p:ajax update="@form" process="@this"
										listener="#{controleCaixaController.verificaData}" />
								</p:datePicker>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-md-12">
							<div class="input-combined">
								<p:outputLabel class="title-input" value="Motivo (opcional)" />
								<p:inputTextarea maxlength="100"
									value="#{controleCaixaController.controleCaixaModel.motivo}"
									disabled="#{controleCaixaController.dadosLiberados}" />
							</div>
						</div>
					</div>
				</div>
				</h:panelGroup>

				<div class="flex justify-center">
					<p:commandButton
						id="btnRegistrarEntradaSaida"
						disabled="#{controleCaixaController.dadosLiberados}"
						class="btn btn-blue medium" value="Registrar" 
						update="@form btnRegistrarEntradaSaida"
						process="@form"
						actionListener="#{controleCaixaController.salvarValores()}"
						oncomplete="handleEntradaSaidaResponse(args);" />
				</div>
			</div>
			
	</ui:define>

</ui:composition>
</html>