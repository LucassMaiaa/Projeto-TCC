<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
	<title><ui:insert name="title">BarberSys</ui:insert></title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" type="text/css" href="#{request.contextPath}/resources/css/global.css" />
	<link rel="stylesheet" type="text/css" href="#{request.contextPath}/resources/css/sweetalert-fix.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	
	<!-- CSS adicional específico da página -->
	<ui:insert name="extra-css" />
</h:head>

<h:body>

	<h:form id="form" styleClass="main">
		<!-- Auto-refresh de notificações a cada 30 segundos -->
		<p:poll interval="30" 
		        listener="#{notificacaoController.atualizarNotificacoes()}" 
		        update="notificationBadge" 
		        process="@this"
		        autoStart="true" />
		
		<!-- Grid com 3 colunas: menu lateral esquerdo, conteúdo central e sidebar direito -->
		<div class="grid-content has-sidebar">

			<!-- MENU LATERAL ESQUERDO -->
			<ui:include src="/menu_lateral.xhtml" />

			<!-- CONTEÚDO PRINCIPAL -->
			<div class="content-dashboard">
				
				<!-- HEADER COM PERFIL, NOTIFICAÇÕES E BOTÃO SAIR -->
				<div class="content-perfil flex space-between">
					<div class="flex align-center">
						<div class="avatar-circle btn-circle mr8"></div>

						<div class="content-title-perfil">
							<h:outputText class="title-welcome-perfil" value="Olá" />
							<h:outputText class="title-name-perfil" value="#{usuarioController.nomeUsuarioLogado}" />
						</div>
					</div>
					<div class="flex align-center" style="gap: 10px;">
						<!-- Botão Ajuda -->
						<p:commandButton class="btn-ajuda-header" value="Ajuda"
							icon="fa-solid fa-circle-info" 
							onclick="abrirAjudaPDF(); return false;" />
						
						<!-- Botão Notificações -->
						<div style="position: relative; display: inline-block;">
							<p:commandButton id="botaoNotificacao" class="btn-circle" icon="fa-solid fa-bell" />
							<h:panelGroup id="notificationBadge">
								<h:outputText styleClass="notification-badge" 
								              value="#{notificacaoController.totalNaoLidas}"
								              rendered="#{notificacaoController.totalNaoLidas > 0}" />
							</h:panelGroup>
						</div>
						
						<!-- Botão Sair (Link HTML puro - 100% garantido) -->
						<a href="#{request.contextPath}/logout.xhtml" 
						   class="btn-sair-header ui-button ui-widget ui-state-default ui-corner-all ui-button-text-icon-left"
						   style="position: relative; z-index: 200; text-decoration: none; display: inline-flex; align-items: center;">
						    <span class="ui-button-icon-left ui-icon fa-solid fa-right-from-bracket"></span>
						    <span class="ui-button-text">Sair</span>
						</a>
					</div>
				</div>

				<!-- PAINEL DE NOTIFICAÇÕES -->
				<p:overlayPanel id="painelNotificacoes" for="botaoNotificacao" styleClass="notif-panel" style="width:380px" dismissable="true">
					<p:ajax event="show" listener="#{notificacaoController.marcarTodasComoLidas()}" update="@form:notificationBadge" />

					<!-- Cabeçalho do Painel -->
					<div class="notif-header">
						<span class="notif-title">Notificações</span>
						<p:commandButton value="Limpar todas" 
										 styleClass="notif-clear-all"
										 onclick="PF('dlgConfirmLimparTodas').show();"
										 process="@this"
										 rendered="#{not empty notificacaoController.notificacoes}" />
					</div>

					<!-- Lista de Itens -->
					<h:panelGroup rendered="#{not empty notificacaoController.notificacoes}" layout="block">
						<ul class="notif-list">
							<ui:repeat value="#{notificacaoController.notificacoes}" var="notificacao">
								<li class="notif-item #{notificacao.lida eq 'N' ? 'unread' : ''}">
									
									<!-- Indicador de não lido -->
									<h:panelGroup rendered="#{notificacao.lida eq 'N'}" layout="block" styleClass="notif-unread-dot" />
									
									<!-- Conteúdo Principal -->
									<div class="notif-content">
										<p class="notif-message">#{notificacao.mensagem}</p>
										<p class="notif-meta">
											<h:outputText value="#{notificacao.dataEnvio}">
												<f:convertDateTime pattern="dd/MM/yyyy 'às' HH:mm" />
											</h:outputText>
										</p>
									</div>
									
									<!-- Ações que aparecem no Hover -->
									<div class="notif-actions">
										<p:commandButton rendered="#{notificacao.mensagem.contains('Avalie o serviço prestado')}"
														 icon="fa fa-star" 
														 actionListener="#{avaliacaoController.abrirModalAvaliacao(notificacao)}"
														 oncomplete="PF('dlgAvaliacao').show();"
														 update="@form:formAvaliacao"
														 title="Avaliar atendimento"
														 styleClass="ui-button-warning ui-button-flat ui-button-icon-only" />
										
										<p:commandButton icon="fa fa-trash" 
														 actionListener="#{notificacaoController.selecionarNotificacao(notificacao)}"
														 oncomplete="PF('dlgConfirmNotificacao').show();"
														 update="@form:dlgConfirmNotificacaoForm"
														 title="Remover notificação"
														 styleClass="ui-button-danger ui-button-flat ui-button-icon-only" />
									</div>
								</li>
							</ui:repeat>
						</ul>
					</h:panelGroup>

					<!-- Estado de Lista Vazia -->
					<h:panelGroup rendered="#{empty notificacaoController.notificacoes}" layout="block" styleClass="notif-empty">
						<div class="notif-empty-icon">
							<i class="fa-regular fa-bell-slash"></i>
						</div>
						<p class="notif-empty-text">Nenhuma notificação no momento</p>
					</h:panelGroup>
				</p:overlayPanel>

				<!-- MODAL DE AVALIAÇÃO -->
				<p:dialog id="dlgAvaliacao" widgetVar="dlgAvaliacao" modal="true" resizable="false" 
				          width="600" responsive="true" closable="false">
				    
				    <h:panelGroup id="formAvaliacao">
				        
				        <!-- Header do Modal -->
				        <div class="header-modal">
				            <span>Avaliar Atendimento</span>
				            <p:commandButton icon="fa fa-times" 
				                           styleClass="btn-x"
				                           onclick="PF('dlgAvaliacao').hide(); return false;"
				                           process="@this" />
				        </div>
				        
				        <!-- Informações do Funcionário -->
				        <div style="text-align: center; margin: 20px 0 30px;">
				            <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600; color: #0C0C17;">
				                #{avaliacaoController.nomeFuncionario}
				            </h3>
				            <p style="margin: 0; color: #6B7280; font-size: 14px;">Como foi seu atendimento?</p>
				        </div>

				        <!-- SISTEMA DE ESTRELAS -->
				        <div style="text-align: center; margin: 40px 0; padding: 20px; background: #F9FAFB; border-radius: 8px;">
				            <span onclick="document.getElementById('form:estrela1').click();" style="cursor: pointer; display: inline-block; transition: transform 0.2s;">
				                <i class="#{avaliacaoController.getEstrelaClass(1)}" 
				                   style="font-size: 48px; margin: 0 8px; color: #FFD700; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
				                </i>
				            </span>
				            <p:commandButton id="estrela1" style="display:none;">
				                <p:ajax listener="#{avaliacaoController.selecionarNota(1)}" 
				                        update="formAvaliacao" />
				            </p:commandButton>
				            
				            <span onclick="document.getElementById('form:estrela2').click();" style="cursor: pointer; display: inline-block; transition: transform 0.2s;">
				                <i class="#{avaliacaoController.getEstrelaClass(2)}" 
				                   style="font-size: 48px; margin: 0 8px; color: #FFD700; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
				                </i>
				            </span>
				            <p:commandButton id="estrela2" style="display:none;">
				                <p:ajax listener="#{avaliacaoController.selecionarNota(2)}" 
				                        update="formAvaliacao" />
				            </p:commandButton>
				            
				            <span onclick="document.getElementById('form:estrela3').click();" style="cursor: pointer; display: inline-block; transition: transform 0.2s;">
				                <i class="#{avaliacaoController.getEstrelaClass(3)}" 
				                   style="font-size: 48px; margin: 0 8px; color: #FFD700; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
				                </i>
				            </span>
				            <p:commandButton id="estrela3" style="display:none;">
				                <p:ajax listener="#{avaliacaoController.selecionarNota(3)}" 
				                        update="formAvaliacao" />
				            </p:commandButton>
				            
				            <span onclick="document.getElementById('form:estrela4').click();" style="cursor: pointer; display: inline-block; transition: transform 0.2s;">
				                <i class="#{avaliacaoController.getEstrelaClass(4)}" 
				                   style="font-size: 48px; margin: 0 8px; color: #FFD700; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
				                </i>
				            </span>
				            <p:commandButton id="estrela4" style="display:none;">
				                <p:ajax listener="#{avaliacaoController.selecionarNota(4)}" 
				                        update="formAvaliacao" />
				            </p:commandButton>
				            
				            <span onclick="document.getElementById('form:estrela5').click();" style="cursor: pointer; display: inline-block; transition: transform 0.2s;">
				                <i class="#{avaliacaoController.getEstrelaClass(5)}" 
				                   style="font-size: 48px; margin: 0 8px; color: #FFD700; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
				                </i>
				            </span>
				            <p:commandButton id="estrela5" style="display:none;">
				                <p:ajax listener="#{avaliacaoController.selecionarNota(5)}" 
				                        update="formAvaliacao" />
				            </p:commandButton>
				        </div>

				        <!-- Campo de Comentário -->
				        <div class="input-combined mt15">
				            <span class="title-input">COMENTÁRIO (OPCIONAL)</span>
				            <p:inputTextarea id="comentario" value="#{avaliacaoController.comentario}" 
				                           rows="4" maxlength="500"
				                           placeholder="Compartilhe sua experiência..." />
				        </div>

				        <!-- Botões de Ação -->
				        <div class="flex justify-center mt30">
				            <p:commandButton value="Enviar Avaliação" 
				                           actionListener="#{avaliacaoController.salvarAvaliacao()}"
				                           styleClass="btn btn-green medium"
				                           update="@form:painelNotificacoes" />
				        </div>

				    </h:panelGroup>
				</p:dialog>

				<!-- MODAL DE CONFIRMAÇÃO DE EXCLUSÃO DE NOTIFICAÇÃO -->
				<p:dialog id="dlgConfirmNotificacao" widgetVar="dlgConfirmNotificacao" modal="true"
					showEffect="fade" hideEffect="fade" closable="false"
					draggable="false" resizable="false">
					<h:panelGroup id="dlgConfirmNotificacaoForm">
						<div class="header-modal-confirm">
							<div>
								<label>Realmente deseja excluir essa notificação?</label>
							</div>
						</div>

						<div class="flex align-center justify-center">
							<p:commandButton styleClass="btn medium btn-confirm"
								value="Confirmar"
								actionListener="#{notificacaoController.confirmarRemocao()}"
								update="@form:painelNotificacoes @form:notificationBadge" />
							<p:commandButton styleClass="btn medium btn-cancel"
								value="Cancelar" onclick="PF('dlgConfirmNotificacao').hide()" />
						</div>

					</h:panelGroup>
				</p:dialog>

				<!-- MODAL DE CONFIRMAÇÃO PARA LIMPAR TODAS AS NOTIFICAÇÕES -->
				<p:dialog id="dlgConfirmLimparTodas" widgetVar="dlgConfirmLimparTodas" modal="true"
					showEffect="fade" hideEffect="fade" closable="false"
					draggable="false" resizable="false">
					<h:panelGroup id="dlgConfirmLimparTodasForm">
						<div class="header-modal-confirm">
							<div>
								<label>Realmente deseja remover todas as notificações?</label>
							</div>
						</div>

						<div class="flex align-center justify-center">
							<p:commandButton styleClass="btn medium btn-confirm"
								value="Confirmar"
								actionListener="#{notificacaoController.limparTodas()}"
								update="@form:painelNotificacoes @form:notificationBadge"
								oncomplete="PF('dlgConfirmLimparTodas').hide();" />
							<p:commandButton styleClass="btn medium btn-cancel"
								value="Cancelar" onclick="PF('dlgConfirmLimparTodas').hide()" />
						</div>

					</h:panelGroup>
				</p:dialog>

				<script>
					function abrirAjudaPDF() {
						// Pega o nome da página atual
						var paginaAtual = window.location.pathname.split('/').pop().replace('.xhtml', '');
						
						// ========================================================================
						// MAPA DE PÁGINAS: Configure aqui qual página do PDF deve abrir para cada tela
						// ========================================================================
						// COMO USAR:
						// 1. À esquerda: coloque o nome da sua página .xhtml (sem extensão)
						// 2. À direita: coloque o número da página do PDF
						// 
						// EXEMPLO: Se sua tela é "minha_tela.xhtml" e deve abrir na página 5 do PDF:
						//          'minha_tela': 5
						//
						// IMPORTANTE: O PDF vai fazer SCROLL automático até a página especificada
						// usando o parâmetro #page=N na URL do PDF
						// ========================================================================
						var mapaPaginas = {
							'dashboard': 19,             // Dashboard abre na página 21 do PDF
							'agendamento': 20,
							'relatorios': 23,      
							'relatorio_feedback': 23,
							'relatorio_agendamentos': 24,
							'relatorio_analitico_agendamentos': 25,
							'relatorio_pagamentos': 25,
							'relatorio_faturamento': 26,
							'relatorio_produtividade': 27,
							'cadastros': 28,
							'cadastro_clientes': 28,
							'cadastro_funcionario': 29,
							'cadastro_pagamento': 30,
							'cadastro_servicos': 31,
							'cadastro_restricao_data': 31,
							'controle_caixa': 32, 
							'configuracoes_admin': 36,
							'agendamentoCliente': 39,
							'configuracoes': 37,
							'configuracoes_funcionario': 37,
						};
						
						// Pega o número da página correspondente (se não encontrar, usa página 1)
						var numeroPagina = mapaPaginas[paginaAtual] || 1;
						
						// Abre o PDF na página correspondente em nova aba
						// O parâmetro #page=N faz o PDF dar scroll automático até a página N
						var urlPDF = '#{request.contextPath}/resources/pdf/ManualDoSistema.pdf#page=' + numeroPagina;
						window.open(urlPDF, '_blank');
					}
				</script>

				<style>
				    .estrela-link {
				        text-decoration: none !important;
				    }
				    
				    .estrela-selecionada {
				        color: #FFD700 !important;
				    }
				    
				    .estrela-vazia {
				        color: #ddd !important;
				    }
				    
				    .estrela-link i:hover {
				        transform: scale(1.2);
				        transition: transform 0.2s;
				    }
				    
				    .notificacao-link:hover {
				        background: #e8e8e8 !important;
				    }
				    
				    .notification-badge {
				        position: absolute;
				        top: -5px;
				        right: -5px;
				        background-color: #E74A46;
				        color: white;
				        border-radius: 50%;
				        width: 20px;
				        height: 20px;
				        display: flex;
				        align-items: center;
				        justify-content: center;
				        font-size: 11px;
				        font-weight: bold;
				        border: 2px solid white;
				        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
				    }
				</style>

				<!-- CONTEÚDO ESPECÍFICO DA PÁGINA -->
				<ui:insert name="content">
					<!-- Aqui vai o conteúdo central de cada página -->
				</ui:insert>

			</div>
			
			<!-- SIDEBAR LATERAL DIREITO -->
			<div class="content-info-lateral">
				<ui:insert name="sidebar">
					<!-- Aqui vai o conteúdo do menu lateral direito -->
				</ui:insert>
			</div>

		</div>
	</h:form>

</h:body>
</html>
