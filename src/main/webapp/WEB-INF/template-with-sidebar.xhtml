<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
	<title><ui:insert name="title">BarberSys</ui:insert></title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" type="text/css" href="#{request.contextPath}/resources/css/global.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	
	<!-- CSS adicional espec√≠fico da p√°gina -->
	<ui:insert name="extra-css" />
</h:head>

<h:body>

	<h:form id="form" styleClass="main">
		<!-- Auto-refresh de notifica√ß√µes a cada 30 segundos -->
		<p:poll interval="30" 
		        listener="#{notificacaoController.atualizarNotificacoes()}" 
		        update="notificationBadge" 
		        autoStart="true" />
		
		<!-- Grid com 3 colunas: menu lateral esquerdo, conte√∫do central e sidebar direito -->
		<div class="grid-content has-sidebar">

			<!-- MENU LATERAL ESQUERDO -->
			<ui:include src="/menu_lateral.xhtml" />

			<!-- CONTE√öDO PRINCIPAL -->
			<div class="content-dashboard">
				
				<!-- HEADER COM PERFIL, NOTIFICA√á√ïES E BOT√ÉO SAIR -->
				<div class="content-perfil flex space-between">
					<div class="flex align-center">
						<div class="avatar-circle btn-circle mr8"></div>

						<div class="content-title-perfil">
							<h:outputText class="title-welcome-perfil" value="Ol√°" />
							<h:outputText class="title-name-perfil" value="#{usuarioController.nomeUsuarioLogado}" />
						</div>
					</div>
					<div class="flex">
						<div style="position: relative; display: inline-block;">
							<p:commandButton id="botaoNotificacao" class="btn-circle" icon="fa-solid fa-bell" />
							<h:panelGroup id="notificationBadge">
								<h:outputText styleClass="notification-badge" 
								              value="#{notificacaoController.totalNaoLidas}"
								              rendered="#{notificacaoController.totalNaoLidas > 0}" />
							</h:panelGroup>
						</div>

						<p:commandButton class="btn-sair-header" value="Sair"
							icon="fa-solid fa-right-from-bracket" 
							action="#{usuarioController.logout}" />
					</div>
				</div>

				<!-- PAINEL DE NOTIFICA√á√ïES -->
				<p:overlayPanel id="painelNotificacoes" for="botaoNotificacao" style="width:350px" dismissable="true">
					<p:ajax event="show" listener="#{notificacaoController.marcarTodasComoLidas()}" 
					        update="@form:notificationBadge" />
					<div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px;">
						<span style="font-weight: bold; font-size: 1.2em;">Notifica√ß√µes</span>
						<p:commandButton value="Limpar todas" 
						                 icon="fa fa-trash-alt"
						                 styleClass="ui-button-secondary ui-button-sm"
						                 style="font-size: 11px; padding: 5px 10px;"
						                 onclick="PF('dlgConfirmLimparTodas').show();"
						                 process="@this"
						                 rendered="#{notificacaoController.notificacoes.size() > 0}" />
					</div>
					<p:dataList value="#{notificacaoController.notificacoes}" var="notificacao" type="definition"
					            emptyMessage="Nenhuma notifica√ß√£o no momento üîî"
					            style="max-height: 400px; overflow-y: auto;">
						<f:facet name="description">
							<div style="padding: 10px; border-radius: 5px; margin-bottom: 8px; 
							            #{notificacao.lida eq 'N' ? 'background: #fff3cd; border-left: 3px solid #ffc107; font-weight: 500;' : 'background: #f9f9f9;'}">
								<div>#{notificacao.mensagem}</div>
								<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
									<span style="font-size: 0.8em; color: #888;">
										<h:outputText value="#{notificacao.dataEnvio}">
											<f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
										</h:outputText>
									</span>
									<div>
										<!-- Bot√£o de Avaliar (s√≥ aparece para notifica√ß√µes de finalizado) -->
										<p:commandButton rendered="#{notificacao.mensagem.contains('Avalie o servi√ßo prestado')}"
										                 icon="fa fa-star" 
										                 actionListener="#{avaliacaoController.abrirModalAvaliacao(notificacao)}"
										                 oncomplete="PF('dlgAvaliacao').show();"
										                 update="@form:formAvaliacao"
										                 title="Avaliar atendimento"
										                 styleClass="ui-button-warning ui-button-flat"
										                 style="margin-right: 5px;" />
										
										<!-- Bot√£o de Remover (s√≥ aparece para notifica√ß√µes normais) -->
										<p:commandButton rendered="#{!notificacao.mensagem.contains('Avalie o servi√ßo prestado')}"
										                 icon="fa fa-trash" 
										                 actionListener="#{notificacaoController.selecionarNotificacao(notificacao)}"
										                 oncomplete="PF('dlgConfirmNotificacao').show();"
										                 update="@form:dlgConfirmNotificacaoForm"
										                 title="Remover notifica√ß√£o"
										                 styleClass="ui-button-danger ui-button-flat" />
									</div>
								</div>
							</div>
						</f:facet>
					</p:dataList>
				</p:overlayPanel>

				<!-- MODAL DE AVALIA√á√ÉO -->
				<p:dialog id="dlgAvaliacao" widgetVar="dlgAvaliacao" header="Avaliar Atendimento" 
				          modal="true" resizable="false" width="500" responsive="true">
				    
				    <h:panelGroup id="formAvaliacao">
				        
				        <div style="text-align: center; margin-bottom: 20px;">
				            <h3 style="margin: 10px 0; color: #333;">#{avaliacaoController.nomeFuncionario}</h3>
				            <p style="color: #666; font-size: 14px;">Como foi seu atendimento?</p>
				        </div>

				        <!-- SISTEMA DE ESTRELAS -->
				        <div style="text-align: center; margin: 30px 0;">
				            <span onclick="document.getElementById('form:estrela1').click();" style="cursor: pointer;">
				                <i class="#{avaliacaoController.getEstrelaClass(1)}" 
				                   style="font-size: 40px; margin: 0 5px; color: #FFD700;">
				                </i>
				            </span>
				            <p:commandButton id="estrela1" style="display:none;">
				                <p:ajax listener="#{avaliacaoController.selecionarNota(1)}" 
				                        update="formAvaliacao" />
				            </p:commandButton>
				            
				            <span onclick="document.getElementById('form:estrela2').click();" style="cursor: pointer;">
				                <i class="#{avaliacaoController.getEstrelaClass(2)}" 
				                   style="font-size: 40px; margin: 0 5px; color: #FFD700;">
				                </i>
				            </span>
				            <p:commandButton id="estrela2" style="display:none;">
				                <p:ajax listener="#{avaliacaoController.selecionarNota(2)}" 
				                        update="formAvaliacao" />
				            </p:commandButton>
				            
				            <span onclick="document.getElementById('form:estrela3').click();" style="cursor: pointer;">
				                <i class="#{avaliacaoController.getEstrelaClass(3)}" 
				                   style="font-size: 40px; margin: 0 5px; color: #FFD700;">
				                </i>
				            </span>
				            <p:commandButton id="estrela3" style="display:none;">
				                <p:ajax listener="#{avaliacaoController.selecionarNota(3)}" 
				                        update="formAvaliacao" />
				            </p:commandButton>
				            
				            <span onclick="document.getElementById('form:estrela4').click();" style="cursor: pointer;">
				                <i class="#{avaliacaoController.getEstrelaClass(4)}" 
				                   style="font-size: 40px; margin: 0 5px; color: #FFD700;">
				                </i>
				            </span>
				            <p:commandButton id="estrela4" style="display:none;">
				                <p:ajax listener="#{avaliacaoController.selecionarNota(4)}" 
				                        update="formAvaliacao" />
				            </p:commandButton>
				            
				            <span onclick="document.getElementById('form:estrela5').click();" style="cursor: pointer;">
				                <i class="#{avaliacaoController.getEstrelaClass(5)}" 
				                   style="font-size: 40px; margin: 0 5px; color: #FFD700;">
				                </i>
				            </span>
				            <p:commandButton id="estrela5" style="display:none;">
				                <p:ajax listener="#{avaliacaoController.selecionarNota(5)}" 
				                        update="formAvaliacao" />
				            </p:commandButton>
				        </div>

				        <div style="margin-bottom: 20px;">
				            <h:outputLabel value="Deixe seu coment√°rio (opcional):" style="font-weight: bold; display: block; margin-bottom: 8px;" />
				            <p:inputTextarea id="comentario" value="#{avaliacaoController.comentario}" 
				                           rows="4" cols="50" maxlength="500"
				                           placeholder="Compartilhe sua experi√™ncia..."
				                           style="width: 100%;" />
				        </div>

				        <div style="text-align: center; margin-top: 20px;">
				            <p:commandButton value="Avaliar" 
				                           actionListener="#{avaliacaoController.salvarAvaliacao()}"
				                           styleClass="ui-button-success"
				                           style="margin-right: 10px;" 
				                           update="@form:painelNotificacoes" />
				            
				            <p:commandButton value="Cancelar" 
				                           onclick="PF('dlgAvaliacao').hide(); return false;"
				                           styleClass="ui-button-secondary" />
				        </div>

				    </h:panelGroup>
				</p:dialog>

				<!-- MODAL DE CONFIRMA√á√ÉO DE EXCLUS√ÉO DE NOTIFICA√á√ÉO -->
				<p:dialog id="dlgConfirmNotificacao" widgetVar="dlgConfirmNotificacao" modal="true"
					showEffect="fade" hideEffect="fade" closable="false"
					draggable="false" resizable="false">
					<h:panelGroup id="dlgConfirmNotificacaoForm">
						<div class="header-modal-confirm">
							<div>
								<label>Realmente deseja excluir essa notifica√ß√£o?</label>
							</div>
						</div>

						<div class="flex align-center justify-center">
							<p:commandButton styleClass="btn medium btn-confirm"
								value="Confirmar"
								actionListener="#{notificacaoController.confirmarRemocao()}"
								update="@form:painelNotificacoes @form:notificationBadge" />
							<p:commandButton styleClass="btn medium btn-cancel"
								value="Cancelar" onclick="PF('dlgConfirmNotificacao').hide()" />
						</div>

					</h:panelGroup>
				</p:dialog>

				<!-- MODAL DE CONFIRMA√á√ÉO PARA LIMPAR TODAS AS NOTIFICA√á√ïES -->
				<p:dialog id="dlgConfirmLimparTodas" widgetVar="dlgConfirmLimparTodas" modal="true"
					showEffect="fade" hideEffect="fade" closable="false"
					draggable="false" resizable="false">
					<h:panelGroup id="dlgConfirmLimparTodasForm">
						<div class="header-modal-confirm">
							<div>
								<label>Realmente deseja remover todas as notifica√ß√µes?</label>
							</div>
						</div>

						<div class="flex align-center justify-center">
							<p:commandButton styleClass="btn medium btn-confirm"
								value="Confirmar"
								actionListener="#{notificacaoController.limparTodas()}"
								update="@form:painelNotificacoes @form:notificationBadge"
								oncomplete="PF('dlgConfirmLimparTodas').hide();" />
							<p:commandButton styleClass="btn medium btn-cancel"
								value="Cancelar" onclick="PF('dlgConfirmLimparTodas').hide()" />
						</div>

					</h:panelGroup>
				</p:dialog>

				<style>
				    .estrela-link {
				        text-decoration: none !important;
				    }
				    
				    .estrela-selecionada {
				        color: #FFD700 !important;
				    }
				    
				    .estrela-vazia {
				        color: #ddd !important;
				    }
				    
				    .estrela-link i:hover {
				        transform: scale(1.2);
				        transition: transform 0.2s;
				    }
				    
				    .notificacao-link:hover {
				        background: #e8e8e8 !important;
				    }
				    
				    .notification-badge {
				        position: absolute;
				        top: -5px;
				        right: -5px;
				        background-color: #E74A46;
				        color: white;
				        border-radius: 50%;
				        width: 20px;
				        height: 20px;
				        display: flex;
				        align-items: center;
				        justify-content: center;
				        font-size: 11px;
				        font-weight: bold;
				        border: 2px solid white;
				        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
				    }
				</style>

				<!-- CONTE√öDO ESPEC√çFICO DA P√ÅGINA -->
				<ui:insert name="content">
					<!-- Aqui vai o conte√∫do central de cada p√°gina -->
				</ui:insert>

			</div>
			
			<!-- SIDEBAR LATERAL DIREITO -->
			<div class="content-info-lateral">
				<ui:insert name="sidebar">
					<!-- Aqui vai o conte√∫do do menu lateral direito -->
				</ui:insert>
			</div>

		</div>
	</h:form>

</h:body>
</html>
